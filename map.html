<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <h1>Traffis - Hyderabad Traffic Alerts Map (unofficial)</h1>
    <p>This map displays real-time traffic alerts and events in Hyderabad, India. The data is sourced from the Cyberabad Traffic Pulse WhatsApp account</p>
    <div id="map"></div>
    
    <div class="time-slider-container">
        <h3>Select time range for traffic alerts</h3>
        <div class="slider-group">
            <label class="slider-label">Start Time</label>
            <input type="range" id="startSlider" class="time-slider" min="0" max="480" value="238" step="1">
            <span id="startTimeDisplay"></span>
        </div>
        <div class="slider-group">
            <label class="slider-label">End Time</label>
            <input type="range" id="endSlider" class="time-slider" min="0" max="480" value="242" step="1">
            <span id="endTimeDisplay"></span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([17.415275150958514, 78.48165413403578], 11);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Store markers for easy access
        var markers = {};
        var allEvents = [];
        var loadEventsTimeout = null;
        
        // Time range variables (in hours from current time)
        var currentTime = new Date();
        var minRange = new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000); // 2 days ago
        var maxRange = new Date(currentTime.getTime() + 2 * 24 * 60 * 60 * 1000); // 2 days from now
        var currentStartTime = new Date(currentTime.getTime() - 2 * 60 * 60 * 1000); // 2 hours ago
        var currentEndTime = new Date(currentTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours from now

        // Initialize time sliders
        function initializeTimeSlider() {
            const startSlider = document.getElementById('startSlider');
            const endSlider = document.getElementById('endSlider');
            const startTimeDisplay = document.getElementById('startTimeDisplay');
            const endTimeDisplay = document.getElementById('endTimeDisplay');
            
            // Set initial values (238 = -2 hours, 242 = +2 hours from center 240)
            startSlider.value = 238;
            endSlider.value = 242;
            
            // Update time display
            updateTimeDisplay();
            
            // Add event listeners
            startSlider.addEventListener('input', function() {
                const startValue = parseInt(this.value);
                const endValue = parseInt(endSlider.value);
                
                // Ensure start is before end
                if (startValue >= endValue) {
                    this.value = endValue - 1;
                }
                
                updateTimesFromSliders();
                updateTimeDisplay();
                throttledLoadEvents();
            });
            
            endSlider.addEventListener('input', function() {
                const startValue = parseInt(startSlider.value);
                const endValue = parseInt(this.value);
                
                // Ensure end is after start
                if (endValue <= startValue) {
                    this.value = startValue + 1;
                }
                
                updateTimesFromSliders();
                updateTimeDisplay();
                throttledLoadEvents();
            });
        }
        
        function updateTimesFromSliders() {
            const startSlider = document.getElementById('startSlider');
            const endSlider = document.getElementById('endSlider');
            
            const startHour = parseInt(startSlider.value) - 240; // Convert to hours from current time
            const endHour = parseInt(endSlider.value) - 240;
            
            currentStartTime = new Date(currentTime.getTime() + startHour * 60 * 60 * 1000);
            currentEndTime = new Date(currentTime.getTime() + endHour * 60 * 60 * 1000);
        }
        
        function updateTimeDisplay() {
            // Format time without seconds
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('startTimeDisplay').textContent = currentStartTime.toLocaleString('en-US', options);
            document.getElementById('endTimeDisplay').textContent = currentEndTime.toLocaleString('en-US', options);
        }
        
        // Throttled function to load events (max once every 3 seconds)
        function throttledLoadEvents() {
            if (loadEventsTimeout) {
                clearTimeout(loadEventsTimeout);
            }
            
            loadEventsTimeout = setTimeout(() => {
                loadEvents();
            }, 300); // 300ms debounce while dragging, then load
        }

        // Define marker colors for different event types
        function getMarkerIcon(type) {
            var color;
            switch(type) {
                case 'active':
                    color = 'orange';
                    break;
                case 'inactive':
                    color = 'green';
                    break;
                default:
                    color = 'blue';
            }
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        // Function to load events from API
        async function loadEvents() {
            try {
                // Convert dates to India timezone format (YYYY-MM-DDTHH:mm)
                const startTimeParam = currentStartTime.toLocaleString('sv-SE', { timeZone: 'Asia/Kolkata' }).replace(' ', 'T').slice(0, 16);
                const endTimeParam = currentEndTime.toLocaleString('sv-SE', { timeZone: 'Asia/Kolkata' }).replace(' ', 'T').slice(0, 16);
                
                const url = `/api/events?start_time=${encodeURIComponent(startTimeParam)}&end_time=${encodeURIComponent(endTimeParam)}`;
                const response = await fetch(url);
                const events = await response.json();
                
                displayEvents(events);
                console.log(`Loaded ${events.length} events for time range ${startTimeParam} to ${endTimeParam}`);
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        // Display events on the map
        function displayEvents(events) {
            // Clear existing markers
            Object.values(markers).forEach(marker => {
                map.removeLayer(marker);
            });
            markers = {};
            
            // Add markers for all events
            events.forEach(event => {
                const marker = L.marker([event.lat, event.long], {
                    icon: getMarkerIcon(event.type)
                }).addTo(map);
                
                const popupContent = `
                    <div>
                        <strong>Type:</strong> ${event.type}<br>
                        <strong>Note:</strong> ${event.note || 'No notes'}<br>
                        <strong>Start:</strong> ${event.start_time ? new Date(event.start_time).toLocaleString() : 'Not specified'}<br>
                        <strong>End:</strong> ${event.end_time ? new Date(event.end_time).toLocaleString() : 'Ongoing'}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers[event.id] = marker;
            });
            
            console.log(`Displaying ${events.length} events on map`);
        }

        // Initialize everything when page loads
        initializeTimeSlider();
        loadEvents();

        // Refresh events every 30 seconds
        setInterval(loadEvents, 30000);
    </script>
</body>
</html>