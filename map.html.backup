<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />\n    <link rel="stylesheet" href="map.css" />
    <style>
        /* Modern Tailwind-inspired CSS Variables */
        :root {
            --primary: #3B82F6;
            --primary-hover: #2563EB;
            --primary-light: #DBEAFE;
            --secondary: #6B7280;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, #FFFFFF 100%);
            color: var(--gray-900);
            line-height: 1.6;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-xl);
            padding: 1rem;
            margin: 1.0rem 0;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .header h2 {
            margin: 0 0 0.75rem 0;
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .header p {
            margin: 0;
            font-size: 1.1rem;
            color: var(--gray-600);
            font-weight: 400;
        }
        
        .alerts-toggle-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .alerts-toggle-container:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl), 0 0 0 1px var(--primary-light);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3.25rem;
            height: 1.75rem;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-300);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1.75rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.25rem;
            bottom: 0.25rem;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
            box-shadow: var(--shadow);
        }
        
        .toggle-label {
            white-space: nowrap;
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: white;
            border-radius: 50%;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            border: 0;
        }
        
        .help-icon:hover {
            transform: scale(1.1) translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .help-dialog {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .help-dialog-content {
            background: white;
            margin: 5% auto;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 42rem;
            max-height: 80vh;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        @keyframes slideUp {
            from { transform: translateY(2rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .help-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .help-dialog-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .help-close {
            color: var(--gray-400);
            font-size: 1.5rem;
            font-weight: 400;
            cursor: pointer;
            line-height: 1;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: all 0.2s ease;
            border: 0;
            background: none;
        }
        
        .help-close:hover {
            color: var(--gray-600);
            background: var(--gray-100);
        }
        
        .help-dialog-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .help-dialog-body ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
            space-y: 1rem;
        }
        
        .help-dialog-body li {
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            background: var(--gray-50);
            border-radius: var(--border-radius-lg);
            border-left: 4px solid var(--primary);
            line-height: 1.6;
            transition: all 0.2s ease;
        }
        
        .help-dialog-body li:hover {
            background: var(--primary-light);
            transform: translateX(0.25rem);
        }
        
        .help-dialog-body strong {
            color: var(--primary-hover);
            font-weight: 600;
        }
        \n        #map {\n            width: 100%;\n            height: 32rem;\n            border: 1px solid var(--gray-200);\n            border-radius: var(--border-radius-xl);\n            box-shadow: var(--shadow-lg);\n            margin: 1.5rem 0;\n        }\n        \n        .time-slider-container {\n            background: rgba(255, 255, 255, 0.95);\n            backdrop-filter: blur(10px);\n            padding: 2rem;\n            margin: 1.5rem 0;\n            border-radius: var(--border-radius-xl);\n            box-shadow: var(--shadow-md);\n            border: 1px solid var(--gray-200);\n        }\n        \n        .time-slider-container h3 {\n            margin: 0 0 1.5rem 0;\n            font-size: 1.25rem;\n            font-weight: 600;\n            color: var(--gray-800);\n            text-align: center;\n        }\n        \n        .slider-group {\n            margin: 1.5rem 0;\n        }\n        \n        .slider-label {\n            display: block;\n            margin-bottom: 0.75rem;\n            font-weight: 600;\n            color: var(--gray-700);\n            font-size: 0.875rem;\n            text-transform: uppercase;\n            letter-spacing: 0.05em;\n        }\n        \n        .time-slider {\n            width: 100%;\n            margin: 0.75rem 0;\n            height: 0.5rem;\n            border-radius: 0.5rem;\n            background: var(--gray-200);\n            outline: none;\n            -webkit-appearance: none;\n            transition: all 0.2s ease;\n        }\n        \n        .time-slider::-webkit-slider-thumb {\n            appearance: none;\n            width: 1.5rem;\n            height: 1.5rem;\n            border-radius: 50%;\n            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);\n            cursor: pointer;\n            box-shadow: var(--shadow-md);\n            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n            border: 2px solid white;\n        }\n        \n        .time-slider::-webkit-slider-thumb:hover {\n            transform: scale(1.1);\n            box-shadow: var(--shadow-lg);\n        }\n        \n        .time-slider::-moz-range-thumb {\n            width: 1.5rem;\n            height: 1.5rem;\n            border-radius: 50%;\n            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);\n            cursor: pointer;\n            border: 2px solid white;\n            box-shadow: var(--shadow-md);\n        }\n        \n        .time-display {\n            display: block;\n            margin-top: 0.5rem;\n            font-size: 0.875rem;\n            color: var(--gray-600);\n            font-weight: 500;\n            padding: 0.5rem 1rem;\n            background: var(--gray-50);\n            border-radius: var(--border-radius);\n            text-align: center;\n            border: 1px solid var(--gray-200);\n        }\n        \n        .footer {\n            text-align: center;\n            margin-top: 3rem;\n            padding: 2rem;\n        }\n        \n        .footer-content {\n            max-width: 24rem;\n            margin: 0 auto;\n            padding: 1.5rem;\n            background: rgba(255, 255, 255, 0.8);\n            backdrop-filter: blur(10px);\n            border-radius: var(--border-radius-xl);\n            border: 1px solid var(--gray-200);\n            box-shadow: var(--shadow);\n        }\n        \n        .footer-content p {\n            margin: 0 0 0.75rem 0;\n            font-size: 0.875rem;\n            color: var(--gray-600);\n            font-weight: 500;\n        }\n        \n        .footer-link {\n            color: var(--primary);\n            font-weight: 600;\n            text-decoration: none;\n            padding: 0.5rem 1rem;\n            border-radius: var(--border-radius);\n            transition: all 0.2s ease;\n            display: inline-block;\n        }\n        \n        .footer-link:hover {\n            color: var(--primary-hover);\n            background: var(--primary-light);\n            transform: translateY(-1px);\n        }\n        \n        /* Responsive Design */\n        @media (max-width: 768px) {\n            body {\n                padding: 1rem;\n            }\n            \n            .header {\n                padding: 1.5rem;\n                margin: 1rem 0;\n            }\n            \n            .header h2 {\n                font-size: 1.875rem;\n                flex-direction: column;\n                gap: 0.5rem;\n            }\n            \n            .alerts-toggle-container {\n                bottom: 1rem;\n                right: 1rem;\n                padding: 1rem 1.25rem;\n                flex-direction: column;\n                text-align: center;\n                gap: 0.75rem;\n            }\n            \n            .toggle-label {\n                white-space: normal;\n                text-align: center;\n            }\n            \n            #map {\n                height: 24rem;\n            }\n            \n            .time-slider-container {\n                padding: 1.5rem;\n                margin: 1rem 0;\n            }\n            \n            .help-dialog-content {\n                margin: 5% auto;\n                width: 95%;\n                max-height: 85vh;\n            }\n            \n            .help-dialog-header,\n            .help-dialog-body {\n                padding: 1.5rem;\n            }\n        }\n    </style>
</head>
<body>
    <div class="header">
        <h3>Hyderabad Traffic Alerts Map <span class="help-icon" onclick="openHelpDialog()">?</span></h3>
        <h5>Real-time traffic alerts in Hyderabad, India â€¢ Data from Cyberabad Traffic Pulse</h5>
    </div>
    
    <div class="alerts-toggle-container">
        <label class="toggle-switch">
            <input type="checkbox" id="alertsToggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Show alerts near my markers only</span>
    </div>
    
    <div id="map"></div>
    
    <!-- Help Dialog -->
    <div id="helpDialog" class="help-dialog">
        <div class="help-dialog-content">
            <div class="help-dialog-header">
                <h3>How to Use the Map</h3>
                <span class="help-close" onclick="closeHelpDialog()">&times;</span>
            </div>
            <div class="help-dialog-body">
                <ul>
                    <li><strong>View Traffic Alerts:</strong> Orange markers show active alerts, green markers show cleared alerts</li>
                    <li><strong>Time Range:</strong> Use the sliders below to filter alerts by time period</li>
                    <li><strong>Add Personal Markers:</strong> Double-click anywhere on the map to add blue markers for your places of interest</li>
                    <li><strong>Remove Personal Markers:</strong> Double-click on your blue markers to remove them</li>
                    <li><strong>Filter by Distance:</strong> Toggle "Show alerts near my markers only" to see only alerts within 2km of your markers</li>
                    <li><strong>Navigate:</strong> Use mouse wheel to zoom, drag to pan, click markers for details</li>
                    <li><strong>Keyboard:</strong> Press Escape to close any open popup</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="time-slider-container">
        <h3>Time Range Filter</h3>
        <div class="slider-group">
            <label class="slider-label">Start Time</label>
            <input type="range" id="startSlider" class="time-slider" min="0" max="480" value="238" step="1">
            <span id="startTimeDisplay" class="time-display"></span>
        </div>
        <div class="slider-group">
            <label class="slider-label">End Time</label>
            <input type="range" id="endSlider" class="time-slider" min="0" max="480" value="242" step="1">
            <span id="endTimeDisplay" class="time-display"></span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([17.450799974617542, 78.3806712061743], 11);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Store markers for easy access
        var markers = {};
        var userMarkers = {};
        var allEvents = [];
        var loadEventsTimeout = null;
        var alertsToggle = false;
        
        // Time range variables (in hours from current time)
        var currentTime = new Date();
        var minRange = new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000); // 2 days ago
        var maxRange = new Date(currentTime.getTime() + 2 * 24 * 60 * 60 * 1000); // 2 days from now
        var currentStartTime = new Date(currentTime.getTime() - 2 * 60 * 60 * 1000); // 2 hours ago
        var currentEndTime = new Date(currentTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours from now

        // Initialize time sliders
        function initializeTimeSlider() {
            const startSlider = document.getElementById('startSlider');
            const endSlider = document.getElementById('endSlider');
            const startTimeDisplay = document.getElementById('startTimeDisplay');
            const endTimeDisplay = document.getElementById('endTimeDisplay');
            
            // Set initial values (238 = -2 hours, 242 = +2 hours from center 240)
            startSlider.value = 238;
            endSlider.value = 242;
            
            // Update time display
            updateTimeDisplay();
            
            // Add event listeners
            startSlider.addEventListener('input', function() {
                const startValue = parseInt(this.value);
                const endValue = parseInt(endSlider.value);
                
                // Ensure start is before end
                if (startValue >= endValue) {
                    this.value = endValue - 1;
                }
                
                updateTimesFromSliders();
                updateTimeDisplay();
                throttledLoadEvents();
            });
            
            endSlider.addEventListener('input', function() {
                const startValue = parseInt(startSlider.value);
                const endValue = parseInt(this.value);
                
                // Ensure end is after start
                if (endValue <= startValue) {
                    this.value = startValue + 1;
                }
                
                updateTimesFromSliders();
                updateTimeDisplay();
                throttledLoadEvents();
            });
        }
        
        function updateTimesFromSliders() {
            const startSlider = document.getElementById('startSlider');
            const endSlider = document.getElementById('endSlider');
            
            const startHour = parseInt(startSlider.value) - 240; // Convert to hours from current time
            const endHour = parseInt(endSlider.value) - 240;
            
            currentStartTime = new Date(currentTime.getTime() + startHour * 60 * 60 * 1000);
            currentEndTime = new Date(currentTime.getTime() + endHour * 60 * 60 * 1000);
        }
        
        function updateTimeDisplay() {
            // Format time without seconds
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('startTimeDisplay').textContent = currentStartTime.toLocaleString('en-US', options);
            document.getElementById('endTimeDisplay').textContent = currentEndTime.toLocaleString('en-US', options);
        }
        
        // Throttled function to load events (max once every 3 seconds)
        function throttledLoadEvents() {
            if (loadEventsTimeout) {
                clearTimeout(loadEventsTimeout);
            }
            
            loadEventsTimeout = setTimeout(() => {
                loadEvents();
            }, 300); // 300ms debounce while dragging, then load
        }

        // Define marker colors for different event types
        function getMarkerIcon(type) {
            var color;
            switch(type) {
                case 'active':
                    color = 'orange';
                    break;
                case 'inactive':
                    color = 'green';
                    break;
                default:
                    color = 'blue';
            }
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        // Function to load events from API
        async function loadEvents() {
            try {
                // Convert dates to India timezone format (YYYY-MM-DDTHH:mm)
                const startTimeParam = currentStartTime.toLocaleString('sv-SE', { timeZone: 'Asia/Kolkata' }).replace(' ', 'T').slice(0, 16);
                const endTimeParam = currentEndTime.toLocaleString('sv-SE', { timeZone: 'Asia/Kolkata' }).replace(' ', 'T').slice(0, 16);
                
                const url = `/api/events?start_time=${encodeURIComponent(startTimeParam)}&end_time=${encodeURIComponent(endTimeParam)}`;
                const response = await fetch(url);
                const events = await response.json();
                
                displayEvents(events);
                console.log(`Loaded ${events.length} events for time range ${startTimeParam} to ${endTimeParam}`);
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        // Display events on the map
        function displayEvents(events) {
            // Clear existing traffic alert markers
            Object.values(markers).forEach(marker => {
                map.removeLayer(marker);
            });
            markers = {};
            
            // Filter events based on toggle state
            let filteredEvents = events;
            if (alertsToggle) {
                filteredEvents = events.filter(event => isEventNearUserMarkers(event));
            }
            
            // Add markers for filtered events
            filteredEvents.forEach(event => {
                const marker = L.marker([event.latitude, event.longitude], {
                    icon: getMarkerIcon(event.type)
                }).addTo(map);
                
                const popupContent = `
                    <div>
                        <strong>Type:</strong> ${event.type}<br>
                        <strong>Note:</strong> ${event.note || 'No notes'}<br>
                        <strong>Start:</strong> ${event.start_time ? event.start_time : 'Not specified'}<br>
                        <strong>End:</strong> ${event.end_time ? event.end_time : 'Not specified'}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers[event.id] = marker;
            });
            
            console.log(`Displaying ${filteredEvents.length} of ${events.length} events on map`);
        }

        // User marker functions
        function loadUserMarkersFromStorage() {
            const stored = localStorage.getItem('traffis_user_markers');
            if (stored) {
                const storedMarkers = JSON.parse(stored);
                Object.keys(storedMarkers).forEach(id => {
                    const data = storedMarkers[id];
                    addUserMarker(data.lat, data.lng, id);
                });
            }
        }
        
        function saveUserMarkersToStorage() {
            const markersData = {};
            Object.keys(userMarkers).forEach(id => {
                const marker = userMarkers[id];
                const latLng = marker.getLatLng();
                markersData[id] = { lat: latLng.lat, lng: latLng.lng };
            });
            localStorage.setItem('traffis_user_markers', JSON.stringify(markersData));
        }
        
        function addUserMarker(lat, lng, id = null) {
            const markerId = id || 'user_' + Date.now();
            
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: blue; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5);"><div style="background-color: white; width: 6px; height: 6px; border-radius: 50%; margin: 6px auto;"></div></div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([lat, lng], { icon: userIcon }).addTo(map);
            
            userMarkers[markerId] = marker;
            saveUserMarkersToStorage();
            
            return markerId;
        }
        
        function removeUserMarker(lat, lng) {
            const tolerance = 0.001;
            let markerToRemove = null;
            
            Object.keys(userMarkers).forEach(id => {
                const marker = userMarkers[id];
                const markerLatLng = marker.getLatLng();
                
                if (Math.abs(markerLatLng.lat - lat) < tolerance && 
                    Math.abs(markerLatLng.lng - lng) < tolerance) {
                    markerToRemove = id;
                }
            });
            
            if (markerToRemove) {
                map.removeLayer(userMarkers[markerToRemove]);
                delete userMarkers[markerToRemove];
                saveUserMarkersToStorage();
                return true;
            }
            return false;
        }
        
        // Calculate distance between two points in kilometers
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Check if an event is within 2km of any user marker
        function isEventNearUserMarkers(event) {
            if (Object.keys(userMarkers).length === 0) return false;
            
            return Object.values(userMarkers).some(marker => {
                const markerLatLng = marker.getLatLng();
                const distance = calculateDistance(
                    event.latitude, event.longitude,
                    markerLatLng.lat, markerLatLng.lng
                );
                return distance <= 2;
            });
        }
        
        // Disable default double-click zoom
        map.doubleClickZoom.disable();
        
        // Variables for mobile touch handling
        let lastTap = 0;
        let isTouch = false;
        
        // Detect if device supports touch
        function isTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }
        
        // Handle marker creation/deletion
        function handleMarkerToggle(lat, lng) {
            if (!removeUserMarker(lat, lng)) {
                addUserMarker(lat, lng);
            }
        }
        
        // Desktop double-click handler
        if (!isTouchDevice()) {
            map.on('dblclick', function(e) {
                e.originalEvent.preventDefault();
                const { lat, lng } = e.latlng;
                handleMarkerToggle(lat, lng);
            });
        } else {
            // Mobile touch handler - detect double tap
            map.on('click', function(e) {
                const now = Date.now();
                const timeSinceLastTap = now - lastTap;
                
                if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
                    // Double tap detected on mobile
                    e.originalEvent.preventDefault();
                    const { lat, lng } = e.latlng;
                    handleMarkerToggle(lat, lng);
                }
                
                lastTap = now;
            });
        }
        
        // Initialize alerts toggle
        function initializeAlertsToggle() {
            const toggle = document.getElementById('alertsToggle');
            toggle.addEventListener('change', function() {
                alertsToggle = this.checked;
                throttledLoadEvents();
            });
        }
        
        // Initialize everything when page loads
        initializeTimeSlider();
        initializeAlertsToggle();
        loadUserMarkersFromStorage();
        loadEvents();

        // Help dialog functions
        function openHelpDialog() {
            document.getElementById('helpDialog').style.display = 'block';
        }
        
        function closeHelpDialog() {
            document.getElementById('helpDialog').style.display = 'none';
        }
        
        // Close dialog when clicking outside
        document.getElementById('helpDialog').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHelpDialog();
            }
        });
        
        // Add escape key handler to close popups and dialog
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const helpDialog = document.getElementById('helpDialog');
                if (helpDialog.style.display === 'block') {
                    closeHelpDialog();
                } else {
                    map.closePopup();
                }
            }
        });
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <p>Questions or feedback? Get in touch</p>
            <a href="mailto:traffis.in@gmail.com" class="footer-link">traffis.in@gmail.com</a>
        </div>
    </footer>
</body>
</html>