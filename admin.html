<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Admin Panel</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="admin-page">
    <div class="header">
        <h1>Traffic Alerts Admin Panel</h1>
        <div class="api-key-status">
            <span class="api-key-indicator" id="apiKeyIndicator"></span>
            <span id="apiKeyStatus">API Key Not Set</span>
            <button class="btn btn-icon" onclick="openApiKeyModal()" title="Configure API Key">ðŸ”‘</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configure API Key</h3>
                <span class="close" onclick="closeApiKeyModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="apiKeyInput">API Key:</label>
                <input type="password" id="apiKeyInput" placeholder="Enter your API key">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
                <button class="btn" onclick="closeApiKeyModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Assistant Section -->
    <div class="section">
        <h2>AI Assistant (optional)</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="llmPrompt">Traffic alert note</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="llmPrompt" placeholder="Enter traffic alert here..." style="flex: 1;" onkeypress="if(event.key==='Enter') callLLM()">
                    <button class="btn btn-primary" onclick="callLLM()">Submit</button>
                </div>
                <small style="color: #6c757d; font-style: italic;">For example :: Vehicle Accident- Traffic congestion Expected on Shilpa Flyover from ORR towards IKEA.</small>
            </div>
        </div>
    </div>

    <!-- Add Event Section -->
    <div class="section">
        <h2>Add New Event</h2>
        <div id="addEventAlert"></div>
        <div class="add-event-container">
            <!-- Map Column -->
            <div class="map-column">
                <h3>Select Location</h3>
                <div id="adminMap"></div>
                <p class="map-instructions">Click or drag the marker to set coordinates</p>
            </div>
            
            <!-- Form Column -->
            <div class="form-column">
                <form id="addEventForm">
                    <div class="form-group">
                        <label for="coordinates">Coordinates (latitude, longitude):</label>
                        <input type="text" id="coordinates" placeholder="17.4065, 78.4772" required>
                        <small style="color: #6c757d; font-style: italic;">Enter coordinates or use the map to select location</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Status:</label>
                            <select id="type" required>
                                <option value="">Select status...</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startTime">Start Time:</label>
                            <input type="datetime-local" id="startTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="endTime">End Time:</label>
                            <input type="datetime-local" id="endTime">
                        </div>
                        <div class="form-group">
                            <label for="note">Note:</label>
                            <textarea id="note" placeholder="Optional note..."></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Event</button>
                </form>
            </div>
        </div>
    </div>

    <!-- List Events Section -->
    <div class="section">
        <h2 class="collapsible-header" onclick="toggleSection('listEventsContent')">
            <span class="collapse-icon">â–¶</span>List Events
        </h2>
        <div id="listEventsContent" class="collapsible-content" style="display: none;">
            <div id="listEventAlert"></div>
            <div class="form-row">
                <div class="form-group">
                    <label for="listStartTime">Start Time (required):</label>
                    <input type="datetime-local" id="listStartTime" required>
                </div>
                <div class="form-group">
                    <label for="listEndTime">End Time (optional):</label>
                    <input type="datetime-local" id="listEndTime">
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button class="btn btn-primary" onclick="listEvents()">Load Events</button>
                </div>
            </div>
            <div id="eventsContainer">
                <p>Enter a start time and click "Load Events" to view events.</p>
            </div>
        </div>
    </div>

    <!-- Delete Event Section -->
    <div class="section">
        <h2 class="collapsible-header" onclick="toggleSection('deleteEventContent')">
            <span class="collapse-icon">â–¶</span>Delete Event
        </h2>
        <div id="deleteEventContent" class="collapsible-content" style="display: none;">
            <div id="deleteEventAlert"></div>
            <div class="delete-form">
                <div class="form-group">
                    <label for="deleteEventId">Event ID:</label>
                    <input type="number" id="deleteEventId" required>
                </div>
                <div class="form-group">
                    <button class="btn btn-danger" onclick="deleteEvent()">Delete Event</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('traffis_api_key');
        let adminMap;
        let adminMarker;
        const defaultCoords = [17.4065, 78.4772]; // Default coordinates (Hyderabad)
        
        updateApiKeyStatus();
        setDefaultListStartTime();
        initializeAdminMap();

        function updateApiKeyStatus() {
            const indicator = document.getElementById('apiKeyIndicator');
            const status = document.getElementById('apiKeyStatus');
            
            if (apiKey) {
                indicator.classList.add('active');
                status.textContent = 'API key is set. You can now add events.';
            } else {
                indicator.classList.remove('active');
                status.textContent = 'API key is not set. Please configure it to use the admin panel.';
            }
        }

        function openApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'block';
            document.getElementById('apiKeyInput').value = '';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                apiKey = input.value.trim();
                localStorage.setItem('traffis_api_key', apiKey);
                updateApiKeyStatus();
                closeApiKeyModal();
                showAlert('addEventAlert', 'API Key saved successfully!', 'success');
            }
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function formatDateForAPI(dateString) {
            if (!dateString) return null;
            // Convert local datetime input to India timezone string
            const date = new Date(dateString);
            return date.toLocaleString('sv-SE', { timeZone: 'Asia/Kolkata' }).replace(' ', 'T');
        }

        function formatDateForInput(indiaTimeString) {
            if (!indiaTimeString) return '';
            // Convert India timezone string to local datetime input format
            const date = new Date(indiaTimeString + '+05:30');
            return date.toLocaleString('sv-SE').replace(' ', 'T');
        }

        function formatDateForDisplay(indiaTimeString) {
            if (!indiaTimeString) return 'N/A';
            // Display India time as-is
            return indiaTimeString;
        }

        function setDefaultListStartTime() {
            // Set default start time to current time - 1 day
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            
            // Convert to local datetime-local format
            const defaultStartTime = oneDayAgo.toLocaleString('sv-SE').replace(' ', 'T');
            
            document.getElementById('listStartTime').value = defaultStartTime;
        }

        // Initialize Admin Map
        function initializeAdminMap() {
            // Initialize map with default coordinates
            adminMap = L.map('adminMap').setView(defaultCoords, 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(adminMap);
            
            // Add draggable marker
            adminMarker = L.marker(defaultCoords, {
                draggable: true
            }).addTo(adminMap);
            
            // Update form when marker is dragged
            adminMarker.on('dragend', function(e) {
                const position = e.target.getLatLng();
                updateCoordinatesForm(position.lat, position.lng);
            });
            
            // Add click handler to map for placing marker
            adminMap.on('click', function(e) {
                const position = e.latlng;
                adminMarker.setLatLng(position);
                updateCoordinatesForm(position.lat, position.lng);
            });
            
            // Set initial coordinates in form
            document.getElementById('coordinates').value = `${defaultCoords[0]}, ${defaultCoords[1]}`;
            
            // Add event listener to coordinates input
            document.getElementById('coordinates').addEventListener('input', function(e) {
                updateMarkerFromForm();
            });
        }

        // Update coordinates form field
        function updateCoordinatesForm(lat, lng) {
            const roundedLat = Math.round(lat * 1000000) / 1000000;
            const roundedLng = Math.round(lng * 1000000) / 1000000;
            document.getElementById('coordinates').value = `${roundedLat}, ${roundedLng}`;
        }

        // Update marker position from form input
        function updateMarkerFromForm() {
            const coordinatesValue = document.getElementById('coordinates').value.trim();
            if (!coordinatesValue) return;
            
            const coordinates = coordinatesValue.split(',').map(coord => coord.trim());
            if (coordinates.length !== 2) return;
            
            const lat = parseFloat(coordinates[0]);
            const lng = parseFloat(coordinates[1]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                const newPosition = [lat, lng];
                adminMarker.setLatLng(newPosition);
                adminMap.setView(newPosition, adminMap.getZoom());
            }
        }

        // Add Event
        document.getElementById('addEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!apiKey) {
                showAlert('addEventAlert', 'Please configure your API key first.', 'error');
                return;
            }

            // Parse coordinates
            const coordinatesValue = document.getElementById('coordinates').value.trim();
            const coordinates = coordinatesValue.split(',').map(coord => coord.trim());
            
            if (coordinates.length !== 2) {
                showAlert('addEventAlert', 'Please enter coordinates in the format: latitude, longitude', 'error');
                return;
            }

            const latitude = parseFloat(coordinates[0]);
            const longitude = parseFloat(coordinates[1]);

            if (isNaN(latitude) || isNaN(longitude)) {
                showAlert('addEventAlert', 'Please enter valid numeric coordinates', 'error');
                return;
            }

            const formData = {
                latitude: latitude,
                longitude: longitude,
                type: document.getElementById('type').value,
                start_time: formatDateForAPI(document.getElementById('startTime').value),
                end_time: formatDateForAPI(document.getElementById('endTime').value),
                note: document.getElementById('note').value
            };

            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('addEventAlert', 'Event added successfully!', 'success');
                    document.getElementById('addEventForm').reset();
                } else {
                    showAlert('addEventAlert', result.error || 'Failed to add event', 'error');
                }
            } catch (error) {
                showAlert('addEventAlert', 'Network error: ' + error.message, 'error');
            }
        });

        // List Events
        async function listEvents() {
            if (!apiKey) {
                showAlert('listEventAlert', 'Please configure your API key first.', 'error');
                return;
            }

            const startTime = document.getElementById('listStartTime').value;
            if (!startTime) {
                showAlert('listEventAlert', 'Start time is required.', 'error');
                return;
            }

            const endTime = document.getElementById('listEndTime').value;
            let url = `/api/events?start_time=${encodeURIComponent(formatDateForAPI(startTime))}`;
            
            if (endTime) {
                url += `&end_time=${encodeURIComponent(formatDateForAPI(endTime))}`;
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                const events = await response.json();

                if (response.ok) {
                    displayEvents(events);
                } else {
                    showAlert('listEventAlert', events.error || 'Failed to load events', 'error');
                }
            } catch (error) {
                showAlert('listEventAlert', 'Network error: ' + error.message, 'error');
            }
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsContainer');
            
            if (events.length === 0) {
                container.innerHTML = '<p>No events found for the specified time range.</p>';
                return;
            }

            let html = '<table class="events-table"><thead><tr>';
            html += '<th>ID</th><th>Latitude</th><th>Longitude</th><th>Type</th>';
            html += '<th>Start Time</th><th>End Time</th><th>Note</th></tr></thead><tbody>';

            events.forEach(event => {
                html += '<tr>';
                html += `<td>${event.id}</td>`;
                html += `<td>${event.latitude}</td>`;
                html += `<td>${event.longitude}</td>`;
                html += `<td>${event.type}</td>`;
                html += `<td>${formatDateForDisplay(event.start_time)}</td>`;
                html += `<td>${formatDateForDisplay(event.end_time)}</td>`;
                html += `<td>${event.note || ''}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete Event
        async function deleteEvent() {
            if (!apiKey) {
                showAlert('deleteEventAlert', 'Please configure your API key first.', 'error');
                return;
            }

            const eventId = document.getElementById('deleteEventId').value;

            if (!eventId) {
                showAlert('deleteEventAlert', 'Event ID is required.', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('deleteEventAlert', 'Event deleted successfully!', 'success');
                    document.getElementById('deleteEventId').value = '';
                } else {
                    showAlert('deleteEventAlert', result.error || 'Failed to delete event', 'error');
                }
            } catch (error) {
                showAlert('deleteEventAlert', 'Network error: ' + error.message, 'error');
            }
        }

        // LLM Assistant
        async function callLLM() {
            if (!apiKey) {
                console.log('Please configure your API key first.');
                showAlert('addEventAlert', 'Please configure your API key first.', 'error');
                return;
            }

            const prompt = document.getElementById('llmPrompt').value.trim();
            if (!prompt) {
                console.log('Please enter a prompt.');
                showAlert('addEventAlert', 'Please enter a prompt.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/llm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ prompt })
                });

                const result = await response.json();
                console.log('LLM Response:', result);

                if (response.ok) {
                    // Populate the Add Event form with LLM response
                    const latitude = result.latitude || '';
                    const longitude = result.longitude || '';
                    
                    // Combine latitude and longitude for coordinates field
                    if (latitude && longitude) {
                        document.getElementById('coordinates').value = `${latitude}, ${longitude}`;
                        // Update map marker as well
                        const newPosition = [parseFloat(latitude), parseFloat(longitude)];
                        adminMarker.setLatLng(newPosition);
                        adminMap.setView(newPosition, adminMap.getZoom());
                    } else {
                        document.getElementById('coordinates').value = '';
                    }

                    // Set the status dropdown value
                    const statusSelect = document.getElementById('type');
                    statusSelect.value = result.status || '';
                    
                    document.getElementById('startTime').value = formatDateForInput(result.start_time) || '';
                    document.getElementById('endTime').value = formatDateForInput(result.end_time) || '';
                    document.getElementById('note').value = result.notes || '';
                    
                    // Clear the LLM prompt input
                    document.getElementById('llmPrompt').value = '';
                    
                    showAlert('addEventAlert', 'Form populated with LLM response!', 'success');
                } else {
                    console.error('LLM API Error:', result.error);
                    showAlert('addEventAlert', 'Error: ' + (result.error || 'Failed to call LLM'), 'error');
                }
            } catch (error) {
                console.error('Network error:', error.message);
                showAlert('addEventAlert', 'Network error: ' + error.message, 'error');
            }
        }

        // Toggle collapsible sections
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('apiKeyModal');
            if (event.target === modal) {
                closeApiKeyModal();
            }
        }
    </script>
</body>
</html>